FROM ubuntu:focal
ENV DEBIAN_FRONTEND noninteractive
COPY install-pfft.sh /tmp
COPY install-scafacos.sh /tmp
COPY ubuntu-packages.txt /tmp
RUN apt-get update && xargs -a /tmp/ubuntu-packages.txt apt-get install --no-install-recommends -y \
    && apt-get install --no-install-recommends -y \
    clang-9 clang-tidy-9 clang-format-9 llvm-9 \
    doxygen \
    ffmpeg \
    gcc-8 g++-8 \
    gcc-9 g++-9 \
    graphviz \
    ipython3 jupyter-notebook jupyter-nbconvert \
    libthrust-dev \
    libnvidia-compute-460-server \
    nvidia-cuda-toolkit \
    python3-matplotlib \
    python3-pint \
    python3-tqdm \
    texlive-base \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

RUN bash /tmp/install-pfft.sh     && rm /tmp/install-pfft.sh && \
    bash /tmp/install-scafacos.sh && rm /tmp/install-scafacos.sh && \
    ldconfig

ENV NVIDIA_VISIBLE_DEVICES all
ENV NVIDIA_DRIVER_CAPABILITIES compute,utility

RUN useradd -m espresso
USER espresso
ENV HOME="/home/espresso"
ENV PATH="${HOME}/.local/bin${PATH:+:$PATH}"
RUN pip3 install --no-cache --user \
  cmake==3.17 \
  autopep8==1.5.0 \
  pycodestyle==2.5.0 \
  pylint==2.4.4 \
  astroid==2.3.3 \
  isort==4.3.4 \
  cmakelang==0.6.13 \
  pre-commit==2.15.0 \
  sphinx==4.2.0 \
  sphinx-toggleprompt==0.0.5 \
  sphinxcontrib-bibtex==2.4.1 \
  GridDataFormats==0.7.0 \
  numpydoc==0.7.0 \
  scipy==1.7.1 \
  MDAnalysis==1.1.1
WORKDIR /home/espresso
